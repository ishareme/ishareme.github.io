<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.2 -->
    <script>
        window.materialVersion = "1.5.2"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">


    <link rel="dns-prefetch" href="https://cdn1.lncld.net"/>













    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            MongoDB与Mongoose | 
        
        黄明照--一个在路上慢慢行走的前端人
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">

    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" itemprop="description" content="黄明照、黄明照的个人博客、黄明照的个人网站、一个在路上慢慢行走的前端人">
    <meta name="keywords" content="黄明照、黄明照的个人博客、黄明照的个人网站、一个在路上慢慢行走的前端人,Mongoose">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?MKetZV3cUTfDxvMffaOezg==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #fff;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="黄明照--一个在路上慢慢行走的前端人">
    <meta name="msapplication-starturl" content="http://www.huangmingzhao.cn/MongoDB-Mongoose.html">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="黄明照--一个在路上慢慢行走的前端人">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://www.huangmingzhao.cn/MongoDB-Mongoose.html">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="MongoDB与Mongoose | 黄明照--一个在路上慢慢行走的前端人">
    <meta property="og:image" content="/img/favicon.png">
    <meta property="og:description" content="黄明照、黄明照的个人博客、黄明照的个人网站、一个在路上慢慢行走的前端人">
    <meta property="og:article:tag" content="Mongoose"> 

    
        <meta property="article:published_time" content="Mon Oct 08 2018 22:49:01 GMT+0800">
        <meta property="article:modified_time" content="Tue Oct 09 2018 11:00:04 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://www.huangmingzhao.cn/MongoDB-Mongoose.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://www.huangmingzhao.cn/MongoDB-Mongoose.html",
    "headline": "MongoDB与Mongoose",
    "datePublished": "Mon Oct 08 2018 22:49:01 GMT+0800",
    "dateModified": "Tue Oct 09 2018 11:00:04 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "黄明照",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar1.jpg"
        },
        "description": "Be A Hero To Myself"
    },
    "publisher": {
        "@type": "Organization",
        "name": "黄明照--一个在路上慢慢行走的前端人",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.png"
        }
    },
    "keywords": ",Mongoose黄明照、黄明照的个人博客、黄明照的个人网站、一个在路上慢慢行走的前端人",
    "description": "黄明照、黄明照的个人博客、黄明照的个人网站、一个在路上慢慢行走的前端人",
}
</script>


    

    <!-- Analytics -->
    
    
        <script>
    var _hmt = _hmt || [];
    (function() {var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?16de35e801aa6d41f4001b2445157db7';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(hm, s);
    })();
</script>
    
    

    <!-- Custom Head -->
    

</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#MongoDB"><span class="post-toc-number">1.</span> <span class="post-toc-text">MongoDB</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#何为MongoDB？"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">何为MongoDB？</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#下载安装"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">下载安装</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#概念"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">概念</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#常见使用"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">常见使用</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Mongoose"><span class="post-toc-number">2.</span> <span class="post-toc-text">Mongoose</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#何为Mongoose？"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">何为Mongoose？</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Schema、Model、Entity"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">Schema、Model、Entity</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Schema"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">Schema</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Model"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">Model</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Entity"><span class="post-toc-number">2.2.3.</span> <span class="post-toc-text">Entity</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#document的CRUD操作"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">document的CRUD操作</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#创建"><span class="post-toc-number">2.3.1.</span> <span class="post-toc-text">创建</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#查询"><span class="post-toc-number">2.3.2.</span> <span class="post-toc-text">查询</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#删除"><span class="post-toc-number">2.3.3.</span> <span class="post-toc-text">删除</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#更新"><span class="post-toc-number">2.3.4.</span> <span class="post-toc-text">更新</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#索引"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">索引</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#虚拟属性VirtualType"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">虚拟属性VirtualType</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#验证器Validate"><span class="post-toc-number">2.6.</span> <span class="post-toc-text">验证器Validate</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#内置验证器"><span class="post-toc-number">2.6.1.</span> <span class="post-toc-text">内置验证器</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#自定义验证器"><span class="post-toc-number">2.6.2.</span> <span class="post-toc-text">自定义验证器</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#错误提示"><span class="post-toc-number">2.6.3.</span> <span class="post-toc-text">错误提示</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#statics和methods"><span class="post-toc-number">2.7.</span> <span class="post-toc-text">statics和methods</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#联表查询"><span class="post-toc-number">2.8.</span> <span class="post-toc-text">联表查询</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#前后钩子"><span class="post-toc-number">2.9.</span> <span class="post-toc-text">前后钩子</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#插件"><span class="post-toc-number">2.10.</span> <span class="post-toc-text">插件</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#聚合函数"><span class="post-toc-number">2.11.</span> <span class="post-toc-text">聚合函数</span></a></li></ol></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                MongoDB与Mongoose
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar1.jpg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>黄明照</strong>
        <span>10月 08, 2018</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/Mongoose/">Mongoose</a>
    </ul>
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    
    <!-- Leancloud Views -->
        <a class="post_share-link" href="#">
            <li class="mdl-menu__item">
                <span id="/MongoDB-Mongoose.html" class="leancloud-views_num" data-flag-title="MongoDB与Mongoose">
     &nbsp;浏览量
</span>

            </li>
        </a>
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=MongoDB与Mongoose&url=http://www.huangmingzhao.cn/MongoDB-Mongoose.html&pic=http://www.huangmingzhao.cn/img/favicon.png&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=MongoDB与Mongoose&url=http://www.huangmingzhao.cn/MongoDB-Mongoose.html&via=黄明照" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://www.huangmingzhao.cn/MongoDB-Mongoose.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://www.huangmingzhao.cn/MongoDB-Mongoose.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=黄明照--一个在路上慢慢行走的前端人&title=MongoDB与Mongoose&summary=黄明照、黄明照的个人博客、黄明照的个人网站、一个在路上慢慢行走的前端人&pics=http://www.huangmingzhao.cn/img/favicon.png&url=http://www.huangmingzhao.cn/MongoDB-Mongoose.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h1 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h1><h2 id="何为MongoDB？"><a href="#何为MongoDB？" class="headerlink" title="何为MongoDB？"></a>何为MongoDB？</h2><p>MongoDB是一个介于关系型数据库和非关系型数据库之间的开源产品，它是功能最为丰富的非关系型数据库，也是最像关系型数据库的非关系型数据库。</p>
<p>MongoDB 将数据存储为一个文档，数据结构由键值(key=&gt;value)对组成。MongoDB 文档类似于 JSON 对象。字段值可以包含其他文档，数组及文档数组。</p>
<h2 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h2><p>下载:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -O https://fastdl.mongodb.org/osx/mongodb-osx-ssl-x86_64-4.0.0.tgz</span><br></pre></td></tr></table></figure></p>
<p>解压:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -zxvf mongodb-osx-ssl-x86_64-4.0.0.tgz</span><br></pre></td></tr></table></figure></p>
<p>重命名为mongodb目录:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mv mongodb-osx-ssl-x86_64-4.0.0 mongodb</span><br></pre></td></tr></table></figure></p>
<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p><img src="http://oubl6fzsm.bkt.clouddn.com/1538979571423.jpg" alt="image"></p>
<h2 id="常见使用"><a href="#常见使用" class="headerlink" title="常见使用"></a>常见使用</h2><ul>
<li><p><strong>查询所有结果</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from article</span><br><span class="line"></span><br><span class="line">db.article.find()</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>指定返回哪些键</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select title, author from article</span><br><span class="line"></span><br><span class="line">db.article.find(&#123;&#125;, &#123;&quot;title&quot;: 1, &quot;author&quot;: 1&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>where条件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from article where title = &quot;深入浅出Node&quot;</span><br><span class="line"></span><br><span class="line">db.article.find(&#123;&quot;title&quot;: &quot;深入浅出Node&quot;&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>and条件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from article where title = &quot;深入浅出Node&quot; and author = &quot;朴灵&quot;</span><br><span class="line"></span><br><span class="line">db.article.find(&#123;&quot;title&quot;: &quot;深入浅出Node&quot;, &quot;author&quot;: &quot;朴灵&quot;&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>or条件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from article where title = &quot;深入浅出Node&quot; or author = &quot;朴灵&quot;</span><br><span class="line"></span><br><span class="line">db.article.find(&#123;&quot;$or&quot;: [&#123;&quot;title&quot;: &quot;深入浅出Node&quot;&#125;, &#123;&quot;author&quot;: &quot;朴灵&quot;&#125;]&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>比较条件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">select * from article where read &gt;= 100</span><br><span class="line"></span><br><span class="line">db.article.find(&#123;&quot;like&quot;: &#123;&quot;$gt&quot;: 100&#125;&#125;) //$gt(&gt;)、$gte(&gt;=)、$lt(&lt;)、$lte(&lt;=) $ne(!=)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select * from article where read &gt;= 100 and read &lt;= 200</span><br><span class="line"></span><br><span class="line">db.article.find(&#123;&quot;like&quot;: &#123;&quot;$gte&quot;: 100, &quot;lte&quot;: 200&#125;&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>in条件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from article where author in (&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)</span><br><span class="line"></span><br><span class="line">db.article.find(&#123;&quot;author&quot;: &#123;&quot;$in&quot;: [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]&#125;&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>like条件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from article where title like &quot;%深入%&quot;</span><br><span class="line"></span><br><span class="line">db.article.find(&#123;&quot;title&quot;: /深入/i&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>取反</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.article.find(&#123;&quot;author&quot;: &#123;&quot;$not&quot;: /mongodb/i&#125;&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>排序</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//升序</span><br><span class="line">select * from article where type = &quot;mongodb&quot; order by read desc</span><br><span class="line">db.article.find(&#123;&quot;type&quot;: &quot;mongodb&quot;&#125;).sort(&#123;&quot;like&quot;: -1&#125;)</span><br><span class="line"></span><br><span class="line">//降序</span><br><span class="line">select * from article where type = &quot;mongodb&quot; order by read asc</span><br><span class="line">db.article.find(&#123;&quot;type&quot;: &quot;mongodb&quot;&#125;).sort(&#123;&quot;like&quot;: 1&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>更新特定字段（$set）</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">update article set like = 10000 where _id = 123</span><br><span class="line"></span><br><span class="line">db.article.update(&#123;&quot;_id&quot;: 123&#125;, &#123; &quot;$set&quot;: &#123;&quot;like&quot;: 10000&#125;&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>递增或递减（$inc）</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.article.update(&#123;&quot;_id&quot;: 123&#125;, &#123; &quot;$inc&quot;: &#123;&quot;like&quot;: 10&#125;&#125;) // 每次count都加10</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>数组追加（$push）</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.game.update(&#123;&quot;_id&quot;: 123&#125;, &#123; &quot;$push&quot;: &#123;&quot;comment&quot;: &apos;真好&apos;&#125;&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>删除指定文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">delete from article where title = &quot;mongodb&quot;</span><br><span class="line"></span><br><span class="line">db.article.remove(&#123;title: &quot;mongodb&quot;&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>**limit和skip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from article limit 10, 20</span><br><span class="line"></span><br><span class="line">db.article.find().skip(10).limit(20)  //结合limit()和skip()来达到分页效果</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">//数据库</span><br><span class="line">use xxx          //创建或选择数据库</span><br><span class="line"></span><br><span class="line">show dbs / collections</span><br><span class="line"></span><br><span class="line">use xxx  db.dropDatabase()  //删除数据库</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//集合</span><br><span class="line">db.createCollection(&quot;mycol&quot;, &#123; capped : true, autoIndexId : true, size : 6142800, max : 10000 &#125; )   //创建集合</span><br><span class="line">db.mycol2.insert(&#123;&quot;name&quot; : &quot;黄明照&quot;&#125;)  //创建集合并插入</span><br><span class="line"></span><br><span class="line">db.mycol2.drop()   //删除集合</span><br><span class="line"></span><br><span class="line">db.mycol2.save(...)   //无_id插入文档 有_id表示更新</span><br><span class="line">               </span><br><span class="line">db.mycol2.update(&#123;&apos;age&apos;: 18&#125;,&#123;$set:&#123;&apos;age&apos;: 20&#125;&#125;) //更新集合</span><br><span class="line"></span><br><span class="line">db.mycol2.remove(&#123;&apos;age&apos;: 20&#125;) //删除文档</span><br><span class="line"></span><br><span class="line">db.mycol2.find(&#123;key1:value1, key2:value2&#125;).pretty()  //查询   并and</span><br><span class="line">db.mycol2.find(&#123;$or: [&#123;key1: value1&#125;, &#123;key2:value2&#125;]&#125;).pretty() //or 或</span><br><span class="line">db.mycol2.find(&#123;&quot;age&quot;: &#123;$gt:18&#125;, $or: [&#123;&quot;name&quot;: &quot;hmz&quot;&#125;,&#123;&quot;name&quot;: &quot;黄明照&quot;&#125;]&#125;).pretty()  //查询   并和或一起使用</span><br><span class="line"></span><br><span class="line">//limit 和 skip 方法   做分页查询</span><br><span class="line">db.COLLECTION_NAME.find().limit(NUMBER)</span><br><span class="line">db.COLLECTION_NAME.find().limit(NUMBER).skip(NUMBER)</span><br><span class="line"></span><br><span class="line">// 排序</span><br><span class="line">db.col.find(&#123;&#125;,&#123;&quot;name&quot;:1, _id:0&#125;).sort(&#123;&quot;age&quot;:-1&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="Mongoose"><a href="#Mongoose" class="headerlink" title="Mongoose"></a>Mongoose</h1><h2 id="何为Mongoose？"><a href="#何为Mongoose？" class="headerlink" title="何为Mongoose？"></a>何为Mongoose？</h2><p>简单的说，Mongoose就是对node环境中MongoDB数据库操作的封装，一个对象模型工具，将数据库中的数据转换为JavaScript对象以供我们在应用中使用。</p>
<h2 id="Schema、Model、Entity"><a href="#Schema、Model、Entity" class="headerlink" title="Schema、Model、Entity"></a>Schema、Model、Entity</h2><p>在使用Mongoose前，先了解一下 Mongoose 中的三个概念：Schema、Model、Entity</p>
<h3 id="Schema"><a href="#Schema" class="headerlink" title="Schema"></a>Schema</h3><p><code>Schema</code>是一种以文件形式存储的数据库模型骨架，不具备数据库的操作能力，其实也可以看作是表结构的定义。</p>
<p>如何创建一个Schema？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">const UserSchema = new Schema(&#123;</span><br><span class="line">    token: String,</span><br><span class="line">    is_banned: &#123;type: Boolean, default: false&#125;, //是否禁言</span><br><span class="line">    enable: &#123; type: Boolean, default: true &#125;, //用户是否有效</span><br><span class="line">    is_actived: &#123;type: Boolean, default: false&#125;, //邮件激活</span><br><span class="line">    username: String,</span><br><span class="line">    password: String,</span><br><span class="line">    email: String,  //email唯一性</span><br><span class="line">    code: String,</span><br><span class="line">    email_time: &#123;type: Date&#125;,</span><br><span class="line">    phone: &#123;type: String&#125;,</span><br><span class="line">    description: &#123; type: String, default: &quot;这个人很懒，什么都没有留下...&quot; &#125;,</span><br><span class="line">    avatar: &#123; type: String, default: &quot;http://p89inamdb.bkt.clouddn.com/default_avatar.png&quot; &#125;,</span><br><span class="line">    bg_url: &#123; type: String, default: &quot;http://p89inamdb.bkt.clouddn.com/FkagpurBWZjB98lDrpSrCL8zeaTU&quot;&#125;,</span><br><span class="line">    ip: String,</span><br><span class="line">    ip_location: &#123; type: Object &#125;,</span><br><span class="line">    agent: &#123; type: String &#125;, // 用户ua</span><br><span class="line">    last_login_time: &#123; type: Date &#125;,</span><br><span class="line">    openid: &#123;</span><br><span class="line">        WeiChat: String,</span><br><span class="line">        WeiBo: String,</span><br><span class="line">        QQ: String,</span><br><span class="line">    &#125;,</span><br><span class="line">    create_time: &#123; type: Date &#125;,</span><br><span class="line">    // retrieve_time: &#123; type: Number &#125;, // 用户发送激活请求的时间</span><br><span class="line">    image_article: [&#123; type: mongoose.Schema.Types.ObjectId, ref: &apos;ImageArticle&apos;, &#125;],</span><br><span class="line">    collection_image_article: [&#123; type: mongoose.Schema.Types.ObjectId, ref: &apos;ImageArticle&apos;, &#125;],</span><br><span class="line">    collection_reading_article: [&#123; type: mongoose.Schema.Types.ObjectId, ref: &apos;ReadingArticle&apos;, &#125;],</span><br><span class="line">    collection_music_article: [&#123; type: mongoose.Schema.Types.ObjectId, ref: &apos;MusicArticle&apos;, &#125;],</span><br><span class="line">    collection_film_article: [&#123; type: mongoose.Schema.Types.ObjectId, ref: &apos;FilmArticle&apos;, &#125;],</span><br><span class="line">    collection_sound_article: [&#123; type: mongoose.Schema.Types.ObjectId, ref: &apos;SoundArticle&apos;, &#125;],</span><br><span class="line">    following_user: [&#123;type: mongoose.Schema.Types.ObjectId, ref: &apos;User&apos;&#125;], //关注</span><br><span class="line">    follower_user: [&#123;type: mongoose.Schema.Types.ObjectId, ref: &apos;User&apos;&#125;] //粉丝</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h3><p>由Schema发布生成的模型，具有抽象属性和行为的数据库操作对象。正是Model的存在，让我们操作数据库更加方便快捷。<br>依赖<code>Schema</code>生成一个<code>Model</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const User = mongoose.model(&quot;User&quot;, UserSchema);</span><br><span class="line">module.exports = User;</span><br></pre></td></tr></table></figure>
<h3 id="Entity"><a href="#Entity" class="headerlink" title="Entity"></a>Entity</h3><p>由Model创建的实体，它的操作也会影响数据库。<br>依赖<code>Model</code>，创造一个<code>Entity</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const UserModel = require(&apos;../../models/user/user&apos;)</span><br><span class="line">const newUser = new UserModel(&#123;</span><br><span class="line">    username: &apos;就这样子吧&apos;,</span><br><span class="line">    password: sha1(&apos;xxx&apos;),</span><br><span class="line">    token: createToken(&apos;就这样子吧&apos;),</span><br><span class="line">    email: &apos;651734877@qq.com&apos;,</span><br><span class="line">    phone: &apos;13003919397&apos;,</span><br><span class="line">    agent: req.headers[&apos;user-agent&apos;],</span><br><span class="line">    ip: ip,</span><br><span class="line">    ip_location: geoip.lookup(ip)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h2 id="document的CRUD操作"><a href="#document的CRUD操作" class="headerlink" title="document的CRUD操作"></a>document的CRUD操作</h2><h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">const Articles = mongoose.model(&apos;Articles&apos;, articleSchema);</span><br><span class="line"></span><br><span class="line">let article = new Articles(&#123; title: &apos;我不知道&apos; &#125;);</span><br><span class="line">//使用实例创建</span><br><span class="line">article.save((err) =&gt; &#123;</span><br><span class="line">  if (err) return handleError(err);</span><br><span class="line">  // saved!</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">//使用Model类创建</span><br><span class="line">Articles.create(&#123; title: &apos;我不知道&apos; &#125;,  (err, article) =&gt;  &#123;</span><br><span class="line">  if (err) return handleError(err);</span><br><span class="line">  // saved!</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><p>Mongoose查找文档很容易，它支持MongoDB的丰富的查询语法。 可以使用每个models的find，findById，findOne等静态方法进行查找文档。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">UserModel.findOne(&#123; &apos;title&apos;: /hello/ &#125;, (err, person) =&gt; &#123;</span><br><span class="line">  if (err) return handleError(err);</span><br><span class="line"> // get data</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"> let user = await UserModel.findOne(&#123;email: userObj.email, is_actived: false&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>有remove()、findOneAndRemove()、findByIdAndRemove()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ArticlesModel.remove(&#123;&apos;_id&apos;: id&#125;, (err) =&gt; &#123;   </span><br><span class="line">    if (err) &#123;   </span><br><span class="line">       return res.status(400).send(&#123;   </span><br><span class="line">            message: &apos;删除失败&apos;,  </span><br><span class="line">            data: []   </span><br><span class="line">        &#125;);   </span><br><span class="line">    &#125; else &#123;   </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><p>有update()、updateMany()、find() + save()、updateOne()、findByIdAndUpdate()、fingOneAndUpdate()等等<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">const userObj = &#123;</span><br><span class="line">    email: req.body.email,  //email唯一性</span><br><span class="line">    username: req.body.username,</span><br><span class="line">    password: password,</span><br><span class="line">    token: createToken(req.body.email),</span><br><span class="line">    is_actived: true,</span><br><span class="line">    ip: ip,</span><br><span class="line">    ip_location: ip_location,</span><br><span class="line">    agent: agent,</span><br><span class="line">    create_time: Date.now(),</span><br><span class="line">&#125;</span><br><span class="line">await UserModel.findOneAndUpdate(&#123;email: userObj.email, is_actived: false&#125;, &#123;</span><br><span class="line">    $set: userObj</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>索引可以加快查询速度，我们通过一个例子来看看效果。<br>在mongo Shell中，我们创建10000条数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mongo</span><br><span class="line"></span><br><span class="line">for (var i = 0; i &lt; 10000; i++)&#123;</span><br><span class="line">    db.users.insert(&#123;&apos;name&apos;:&apos;user&apos; + i&#125;); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="http://oubl6fzsm.bkt.clouddn.com/mongoose-explain.jpg" alt="image"><br>图中可以看出<code>executionTimeMillis</code>字段为7， 表示执行时间为7毫秒。<br>现在我们来添加索引后执行查询：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.hello.ensureIndex(&#123;name: 1&#125;);</span><br><span class="line">db.hello.find(&#123;&apos;name&apos;: &apos;user1000&apos;&#125;).explain(&apos;executionStats&apos;)</span><br></pre></td></tr></table></figure></p>
<p><img src="http://oubl6fzsm.bkt.clouddn.com/mongoose-explain2.jpg" alt="image"><br>图中可以看出<code>executionTimeMillis</code>字段为1。</p>
<p>从上面的实例可以看出，加了索引后，能快速的查询一条，这可以看到索引极大的提升了查询速度。</p>
<p>下面我们看看如何使用Mongoose创建：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const ArticlesSchema = new Schema(&#123;   </span><br><span class="line">  title: &#123;  </span><br><span class="line">    ...</span><br><span class="line">    index: true    / 1 / -1 </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>我们还可以创建唯一索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const ArticlesSchema = new Schema(&#123;   </span><br><span class="line">  title: &#123;   </span><br><span class="line">    ...    </span><br><span class="line">    index: true,   </span><br><span class="line">    unique: true      </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>复合索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ArticlesSchema.index(&#123;name: 1, create_time: -1&#125;);  //可以指定不同字段的排序 1是正序，-1是倒序</span><br></pre></td></tr></table></figure></p>
<p><strong>注</strong>: 对于添加的每一条索引，每次写操作（插入、更新、删除）都将耗费更多的时间。这是因为，当数据发生变化时，不仅要更新文档，还要更新集合上的所有索引。因此，mongodb限制每个集合最多有64个索引。通常，在一个特定的集合上，不应该拥有两个以上的索引。</p>
<h2 id="虚拟属性VirtualType"><a href="#虚拟属性VirtualType" class="headerlink" title="虚拟属性VirtualType"></a>虚拟属性VirtualType</h2><p>虚拟属性并不会存储到MongoDB中，利用它，我们可以格式化和自定义组合属性值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const UsersSchema = new Schema(&#123;  </span><br><span class="line">  ...   </span><br><span class="line">  address: &#123;   </span><br><span class="line">    city: &#123;type: String&#125;,   </span><br><span class="line">    street: &#123;type: String&#125;   </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;);</span><br><span class="line">const address = UsersSchema.virtual(&apos;address.full&apos;);   </span><br><span class="line"></span><br><span class="line">address.get(function () &#123;   </span><br><span class="line">  return this.address.city + &apos; &apos; + this.address.street;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>通过定义set方法，我们可以给两个字段快速赋值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">address.set(function(v) &#123;   </span><br><span class="line">  const split = v.split(&apos; &apos;);   </span><br><span class="line">  this.address.city = split[0];   </span><br><span class="line">  this.address.street = split[1];  </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">const body = &#123;   </span><br><span class="line">  name: &apos;abcd&apos;,   </span><br><span class="line">  phone: &apos;13123123123&apos;,   </span><br><span class="line">  age: 20,   </span><br><span class="line">  sex: &apos;male&apos;   </span><br><span class="line">&#125;;   </span><br><span class="line">const user = new UsersModel(body);   </span><br><span class="line">user.address.full = &apos;xiamen meitu&apos;;   </span><br><span class="line">user.save();</span><br></pre></td></tr></table></figure></p>
<h2 id="验证器Validate"><a href="#验证器Validate" class="headerlink" title="验证器Validate"></a>验证器Validate</h2><h3 id="内置验证器"><a href="#内置验证器" class="headerlink" title="内置验证器"></a>内置验证器</h3><p>Mongoose提供了几个内置验证器。</p>
<ul>
<li>所有的SchemaType都有内置的require验证器。</li>
<li>数值（ Numbers ）有最大（man）和最小（min）的验证器。</li>
<li>字符串（String）有enum，maxLength和minLength验证器。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">const UsersSchema = new Schema(&#123;  </span><br><span class="line">  ...</span><br><span class="line">  age: &#123;   </span><br><span class="line">    type: Number,   </span><br><span class="line">    min: [18, &quot;自定义错误提示&quot;]   </span><br><span class="line">    max: 30,   </span><br><span class="line">    required: true   </span><br><span class="line">  &#125;,   </span><br><span class="line">  sex: &#123;   </span><br><span class="line">    type: String,   </span><br><span class="line">    enum: &#123;   </span><br><span class="line">      values: [&apos;male&apos;, &apos;female&apos;],</span><br><span class="line">      message: &apos;`&#123;PATH&#125;` 是 `&#123;VALUE&#125;`， 您必须确认您的性别!&apos;   </span><br><span class="line">    &#125;,   </span><br><span class="line">    required: true   </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;);  </span><br><span class="line"></span><br><span class="line">mongoose.model(&apos;users&apos;, UsersSchema);</span><br></pre></td></tr></table></figure>
<h3 id="自定义验证器"><a href="#自定义验证器" class="headerlink" title="自定义验证器"></a>自定义验证器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">const UsersSchema = new Schema(&#123;  </span><br><span class="line">  ...   </span><br><span class="line">  phone: &#123;   </span><br><span class="line">    type: String,   </span><br><span class="line">    validate: &#123;   </span><br><span class="line">      validator: function (v) &#123;</span><br><span class="line">          return /1[3|5|8]\d&#123;9&#125;/.test(v);</span><br><span class="line">      &#125;,</span><br><span class="line">      message: &apos;`&#123;PATH&#125;` 必须是有效的11位手机号码!&apos;  </span><br><span class="line">    &#125;,   </span><br><span class="line">    required: true   </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;); </span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line"></span><br><span class="line">UsersSchema.path(&apos;phone&apos;).validate(function (v) &#123;</span><br><span class="line">    return /1[3|5|8]\d&#123;9&#125;/.test(v);</span><br><span class="line">&#125;, &apos;`&#123;PATH&#125;` 必须是有效的11位手机号码!&apos;);</span><br></pre></td></tr></table></figure>
<h3 id="错误提示"><a href="#错误提示" class="headerlink" title="错误提示"></a>错误提示</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const user = new UsersModel(req.body);</span><br><span class="line"></span><br><span class="line">user.save((err, result) =&gt; &#123;</span><br><span class="line">  if (err) &#123;</span><br><span class="line">    console.error(err.errors[&apos;name&apos;][&apos;message&apos;]);</span><br><span class="line">    return res.status(400)</span><br><span class="line">      .send(&#123;</span><br><span class="line">        message: err</span><br><span class="line">       &#125;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    res.jsonp(user);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="statics和methods"><a href="#statics和methods" class="headerlink" title="statics和methods"></a>statics和methods</h2><p>都是schema的属性，statics和methods的区别:</p>
<p>区别就是一个给Model添加方法（statics），<br>一个给实例添加方法（methods）。<br>statics:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">UserSchema.statics.find_by_username = function(username, cb) &#123;</span><br><span class="line">  return this.findOne(&#123;</span><br><span class="line">    username: username</span><br><span class="line">  &#125;, cb);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">UserModal.find_by_username(&apos;hmz&apos;, (err, user) =&gt; &#123;</span><br><span class="line">  console.log(&apos;find_by_username&apos;, user)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>methods:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">UserSchema.methods.is_exist = function(cb) &#123;</span><br><span class="line">  const query = &#123;</span><br><span class="line">    username: this.username,</span><br><span class="line">    password: this.password</span><br><span class="line">  &#125;;</span><br><span class="line">  return this.model(&apos;UserModel&apos;).findOne(query, cb);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const user = new User(&#123;</span><br><span class="line">  username: &apos;hmz&apos;,</span><br><span class="line">  password: &apos;sadsaa&apos;;</span><br><span class="line">&#125;);</span><br><span class="line">user.is_exist(cb)</span><br></pre></td></tr></table></figure></p>
<h2 id="联表查询"><a href="#联表查询" class="headerlink" title="联表查询"></a>联表查询</h2><p>如果你使用过MySql，肯定用过join，用来联表查询，但Mongoose中并没有join，不过它提供了一种更方便快捷的方法：<code>Population</code>。<br>用简短的话来概括Population的使用：在一个Collection(articles)中定义一个指向另一个Collection(comment)的_id字段的字段(comment)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">//FilmComment</span><br><span class="line">const filmCommentSchema = new Schema(&#123;</span><br><span class="line">    ...</span><br><span class="line">    article_id: &#123;type: mongoose.Schema.Types.ObjectId, ref: &apos;FilmArticle&apos;, required: true&#125;,</span><br><span class="line">    ...</span><br><span class="line">    reply_to_id: &#123;type: mongoose.Schema.Types.ObjectId, ref: &apos;FilmComment&apos;&#125;   //ref的值是模型(model)名称 //被回复的评论id</span><br><span class="line">    ...</span><br><span class="line">&#125;)</span><br><span class="line">const FilmComment = mongoose.model(&apos;FilmComment&apos;, filmCommentSchema);</span><br><span class="line">module.exports = FilmComment</span><br><span class="line"></span><br><span class="line">//FilmArticle</span><br><span class="line">const filmArticleSchema = new Schema(&#123;</span><br><span class="line">    ...</span><br><span class="line">    comment: [&#123;type: mongoose.Schema.Types.ObjectId, ref: &apos;FilmComment&apos;&#125;],</span><br><span class="line">    ...</span><br><span class="line">&#125;)</span><br><span class="line">let FilmArticle = mongoose.model(&apos;FilmArticle&apos;, filmArticleSchema);</span><br><span class="line">module.exports = FilmArticle</span><br><span class="line"></span><br><span class="line">const newFilmComment = req.body.reply_to_id ? new FilmCommentModel(&#123;</span><br><span class="line">    article_id: req.body.article_id,</span><br><span class="line">    content: content,</span><br><span class="line">    create_time: Date.now(),</span><br><span class="line">    reply_to_id: req.body.reply_to_id</span><br><span class="line">&#125;) : new FilmCommentModel(&#123;</span><br><span class="line">    article_id: req.body.article_id,</span><br><span class="line">    content: content,</span><br><span class="line">    create_time: Date.now(),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">await FilmCommentModel.create(newFilmComment)</span><br><span class="line">const newFilmArticle = await FilmArticleModel.findByIdAndUpdate(req.body.article_id, &#123;</span><br><span class="line">    $push&apos;: &#123;</span><br><span class="line">        comment: newFilmComment._id</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;new: true&#125;).populate(&#123;</span><br><span class="line">    path: &apos;comment&apos;,</span><br><span class="line">    model: &apos;FilmComment&apos;,</span><br><span class="line">    populate: &#123;</span><br><span class="line">        path: &apos;reply_to_id&apos;,</span><br><span class="line">        model: &apos;FilmComment&apos;,</span><br><span class="line">        populate: &#123;</span><br><span class="line">            path: &apos;user_id&apos;,</span><br><span class="line">            select: &#123;</span><br><span class="line">                password: 0, token: 0</span><br><span class="line">            &#125;,</span><br><span class="line">            model: &apos;User&apos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h2 id="前后钩子"><a href="#前后钩子" class="headerlink" title="前后钩子"></a>前后钩子</h2><p>前：pre() 后：post(),在执行某些操作时可以执行的函数，在Schema上指定。<br>在以下操作中触发执行 中间件<br>schame的钩子有：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">//--------pre 前置</span><br><span class="line">schema.pre(&apos;init&apos;, function (next) &#123;</span><br><span class="line">    console.log(&apos;init&apos;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line">schema.pre(&apos;validate&apos;, function (next) &#123;</span><br><span class="line">    console.log(&apos;validate&apos;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line">schema.pre(&apos;save&apos;, function (next) &#123;</span><br><span class="line">    console.log(&apos;save&apos;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">schema.pre(&apos;find&apos;, function(next) &#123;</span><br><span class="line">    console.log(&apos;find&apos;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line">//--------post 后置</span><br><span class="line">schema.post(&apos;init&apos;, function (doc,next) &#123;</span><br><span class="line">    console.log(&apos;post-init&apos;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line">schema.post(&apos;validate&apos;, function (doc,next) &#123;</span><br><span class="line">    console.log(&apos;post-validate&apos;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line">schema.post(&apos;save&apos;, function (doc,next) &#123;</span><br><span class="line">    console.log(&apos;post-save&apos;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line">schema.post(&apos;find&apos;, function (doc,next) &#123;</span><br><span class="line">    console.log(&apos;post-find&apos;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><p>我们是可以通过插件形式来拓展Schema的功能。</p>
<p>比如文章，当我们修改文章时，一般都会添加一个最后编辑时间，虽然我们可以每次修改时都手动更新，但是我们可以通过插件来自动更新。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// plugins/plugins.js  </span><br><span class="line">module.exports = &#123;   </span><br><span class="line">  lastModified(schema, options) &#123;</span><br><span class="line">    schema.add(&#123; lastMod: Date &#125;)</span><br><span class="line">    schema.pre(&apos;save&apos;, function (next) &#123;    //前置钩子</span><br><span class="line">      this.lastMod = new Date;   </span><br><span class="line">      next()   </span><br><span class="line">    &#125;) </span><br><span class="line">    if (options &amp;&amp; options.index) &#123;</span><br><span class="line">      schema.path(&apos;lastMod&apos;).index(options.index)</span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// articles/filmArticles.js</span><br><span class="line"></span><br><span class="line">const plugins = require(&apos;../plugins/plugins&apos;);  </span><br><span class="line"></span><br><span class="line">filmArticlesSchema.plugin(plugins.lastModified, &#123;index: true&#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h2><p>MongoDB中聚合(aggregate)主要用于处理数据(诸如统计平均值,求和等)，并返回计算后的数据结果。有点类似sql语句中的 count(*)。</p>

        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
    <div id="comment" style='padding:10px;' class="vcomment"></div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
        return GUEST_INFO.indexOf(item) > -1
    });
    var notify = 'false' == true;
    var verify = 'false' == true;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "ztvc2Jdss3JEXFT7bmDXiR6u-gzGzoHsz",
        appKey: "SaIXu97lk5KQeyTiQ6VmgDLF",
        placeholder: "Just go go",
        pageSize:'10',
        avatar:'identicon',
        lang:'zh-cn'
    });
</script>

                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/聊聊毕业设计系列2.html" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar1.jpg" alt="黄明照's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        beheroto@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto: beheroto@gmail.com" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
                <li>
                    <a href="https://github.com/ishareme" target="_blank" title="Github">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">star</i>
                        
                        Github
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/10/">十月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/08/">八月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/03/">三月 2018<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/02/">二月 2018<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/01/">一月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/10/">十月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/08/">八月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/07/">七月 2017<span class="sidebar_archives-count">2</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/渣技术/">渣技术<span class="sidebar_archives-count">18</span></a></li><li><a class="sidebar_archives-link" href="/categories/闲言语/">闲言语<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="https://github.com/ishareme" title="Github">
                
                    <i class="material-icons sidebar-material-icons">star</i>
                
                Github
            </a>
        </li>
        
    
        <li>
            <a href="/links" title="Links">
                
                    <i class="material-icons sidebar-material-icons">group</i>
                
                Links
            </a>
        </li>
        
    
        <li>
            <a href="/gallery" title="Gallery">
                
                    <i class="material-icons sidebar-material-icons">photo_camera</i>
                
                Gallery
            </a>
        </li>
        
            <li class="divider"></li>
        
    
        <li>
            <a href="/tags" title="Tags">
                
                    <i class="material-icons sidebar-material-icons">bookmark_border</i>
                
                Tags
            </a>
        </li>
        
    
        <li>
            <a href="/timeline" title="Timeline">
                
                    <i class="material-icons sidebar-material-icons">timeline</i>
                
                Timeline
            </a>
        </li>
        
    
        <li>
            <a href="http://ougxgesj3.bkt.clouddn.com/%E9%BB%84%E6%98%8E%E7%85%A7-%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88.pdf" title="About">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                About
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">21</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    
        <a href="https://weibo.com/3018998921/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-weibo">
                <span class="visuallyhidden">Weibo</span>
            </button><!--
     --></a>
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/ishareme" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    
        <a href="https://www.linkedin.com/in/%E6%98%8E%E7%85%A7-%E9%BB%84-79042b105/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-linkedin">
                <span class="visuallyhidden">LinkedIn</span>
            </button><!--
     --></a>
    

    <!-- Zhihu -->
    
        <a href="https://www.zhihu.com/people/ishareme/activities" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-zhihu">
                <span class="visuallyhidden">Zhihu</span>
            </button><!--
     --></a>
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
    
    <!-- V2EX -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;2017&nbsp;-<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>黄明照--一个在路上慢慢行走的前端人
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?V/53wGualMuiPM3xoetD5Q==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>





    <!-- Leancloud -->
    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>
        AV.initialize('ztvc2Jdss3JEXFT7bmDXiR6u-gzGzoHsz', 'SaIXu97lk5KQeyTiQ6VmgDLF');
    </script>
    <script type="text/ls-javascript" id="leancloud-views-script">
    function showTime(Counter) {
        var query = new AV.Query(Counter);
        $('.leancloud-views_num').each(function() {
            var url = $(this).attr('id').trim();
            query.equalTo('url', url);
            query.find({
                success: function(results) {
                    if (results.length === 0) {
                        var content = '0 ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                        return;
                    }
                    for (var i = 0; i < results.length; i++) {
                        var object = results[i];
                        var content = object.get('time') + ' ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                    }
                },
                error: function(object, error) {
                    console.log('Error: ' + error.code + ' ' + error.message);
                }
            });
        });
    }

    function addCount(Counter) {
      var Counter = AV.Object.extend('Counter');
      url = $('.leancloud-views_num').attr('id').trim();
      title = $('.leancloud-views_num').attr('data-flag-title').trim();
      var query = new AV.Query(Counter);
      query.equalTo('url', url);
      query.find({
          success: function(results) {
            if (results.length > 0) {
                var counter = results[0];
                counter.fetchWhenSave(true);
                counter.increment('time');
                counter.save(null, {
                    success: function(counter) {
                        var content =  counter.get('time') + ' ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                    },
                    error: function(counter, error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                    }
                });
            } else {
              var newcounter = new Counter();
              newcounter.set('title', title);
              newcounter.set('url', url);
              newcounter.set('time', 1);
              newcounter.save(null, {
                  success: function(newcounter) {
                      console.log('newcounter.get(\'time\')='+newcounter.get('time'));
                      var content = newcounter.get('time') + ' ' + $(document.getElementById(url)).text();
                      $(document.getElementById(url)).text(content);
                  },
                  error: function(newcounter, error) {
                      console.log('Failed to create');
                  }
              });
            }
        },
        error: function(error) {
            console.log('Error:' + error.code + ' ' + error.message);
        }
      });
    }
    $(function() {
        var Counter = AV.Object.extend('Counter');
        if ($('.leancloud-views_num').length === 1) {
            addCount(Counter);
        } else if ($('.post-title-link').length > 1) {
            showTime(Counter);
        }
    });
</script>






   





<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.2 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
